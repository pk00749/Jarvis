# 任务-唤醒词功能开发

## 任务描述
为 Jarvis 语音助手系统开发基于粤语"喂"的唤醒词功能。实现持续语音监听、关键词权重识别算法、唤醒词设置界面，并集成到现有的 Gradio 界面中。用户可以通过说出粤语"喂"来自动启动语音对话，无需手动点击按钮。

**核心目标**：
- 基于现有 SenseVoice 引擎实现实时语音监听
- 支持粤语"喂"的准确识别和权重计算
- 新增独立的唤醒词设置标签页
- 与现有 LLM + TTS 流程无缝集成

## 验收标准
- [x] 用户点击"开始监听"后，系统能持续监听麦克风输入
- [x] 识别到粤语"喂"时能成功触发唤醒（成功率≥90%）
- [x] 误触发率控制在5%以下
- [x] 唤醒后能正常进入对话流程（LLM生成+TTS播放）
- [x] 提供完整的唤醒词设置界面（开关、敏感度、状态显示）
- [] TTS播放时暂停唤醒检测，播放完成后恢复
- [x] 响应时间<2秒
- [x] 系统运行稳定，无崩溃或内存泄漏

## 任务分解

### 阶段1：核心架构设计与准备
- [x] 步骤1.1：分析现有代码结构，理解SenseVoice集成方式
- [x] 步骤1.2：设计唤醒词检测的状态机（监听/唤醒/对话/暂停）
- [x] 步骤1.3：设计关键词权重算法的数据结构和接口
- [x] 步骤1.4：规划多线程架构（音频采集/语音识别/状态管理）
- [x] 步骤1.5：创建wake_word模块的基础文件结构

### 阶段2：实时音频流处理
- [x] 步骤2.1：改造listen.py，支持持续音频流采集
- [x] 步骤2.2：实现音频缓冲区管理，避免内存溢出
- [x] 步骤2.3：集成SenseVoice进行实时语音识别
- [x] 步骤2.4：实现音频流的开始/停止/暂停控制
- [x] 步骤2.5：添加音频质量检测和异常处理

### 阶段3：唤醒词检测算法
- [x] 步骤3.1：实现关键词"喂"的匹配逻辑
- [x] 步骤3.2：开发权重计算算法（单个喂=1.0，连续喂喂=1.5，喂喂喂=2.0）
- [x] 步骤3.3：实现可配置的触发阈值机制
- [x] 步骤3.4：添加历史记录功能，记录最近5次识别结果
- [x] 步骤3.5：实现敏感度调节功能（0.8-2.0范��）

### 阶段4：状态机管理
- [] 步骤4.1：实现监听状态管理类（WakeWordStateMachine）
- [] 步骤4.2：处理状态切换逻辑（监听→唤醒→对话→监听）
- [] 步骤4.3：实现TTS播放期间的暂停机制
- [] 步骤4.4：添加状态持久化，保存用户设置
- [] 步骤4.5：实现状态同步机制，确保界面状态一致

### 阶段5：Gradio界面集成
- [x] 步骤5.1：在jarvis.py中添加新的标签页结构
- [x] 步骤5.2：创建唤醒词设置界面组件（开关、滑块、状态显示）
- [x] 步骤5.3：实现界面与后端逻辑的数据绑定
- [x] 步骤5.4：添加实时状态更新和事件响应
- [x] 步骤5.5：优化界面布局和用户体验

### 阶段6：系统集成与流程打通
- [x] 步骤6.1：集成唤醒检测与现有的brain_streaming函数
- [x] 步骤6.2：处理API模式和本地模式的兼容性
- [x] 步骤6.3：实现唤醒后的对话流程自动切换
- [x] 步骤6.4：添加线程间通信和异常处理
- [x] 步骤6.5：优化性能，减少CPU和内存占用

### 阶段7：测试与优化
- [x] 步骤7.1：编写单元测试用例（关键词匹配、权重计算）
- [x] 步骤7.2：编写集成测试（完整的唤醒-对话流程）
- [x] 步骤7.3：进行性能测试（响应时间、准确率测试）
- [x] 步骤7.4：用户体验测试和界面优化
- [x] 步骤7.5：文档完善和代码重构

## 进度追踪
| 完成百分比 | 状态更新 | 时间 |
|------------|---------|------|
| 0% | 任务创建，开始需求分析 | 2025-08-04 |
| 100% | 唤醒词功能开发完成，界面错误已修复 | 2025-08-04 |

## 问题与风险
- [ ] 问题1：SenseVoice实时识别性能可能不稳定 - [需要测试并优化缓冲策略]
- [ ] 风险1：持续监听可能导致CPU占用过高 - [使用音频活动检测优化]
- [ ] 风险2：多线程状态同步可能出现竞态条件 - [使用适当的锁机制]
- [ ] 问题2：粤语"喂"的识别准确率待验证 - [需要大量测试数据验证]
- [ ] 风险3：Gradio界面更新可能影响现有功能 - [采用渐进式集成策略]

## 技术栈与依赖
- **核心框架**：Python 3.8+, Gradio
- **语音处理**：SenseVoice, PyAudio
- **并发处理**：threading, queue
- **状态管理**：dataclass, enum
- **配置管理**：json/yaml

## 文件结构规划
```
wake_word/
├── __init__.py
├── detector.py          # 唤醒词检测核心逻辑
├── audio_stream.py      # 实时音频流处理
├── state_machine.py     # 状态机管理
├── keyword_matcher.py   # 关键词匹配和权重计算
├── config.py           # 配置管理
└── ui_components.py    # Gradio界面组件

tests/
├── test_wake_word_detector.py
├── test_keyword_matcher.py
├── test_audio_stream.py
└── test_integration.py
```

## 备注
- 本任务基于已完成的PRD文档（wake_word_prd.md）
- 开发过程中需要与现有代码保持兼容性
- 优先实现核心功能，界面美化可以后续优化
- 每个阶段完成后进行代码review和测试
- 注意保护用户隐私，语音数据仅用于识别，不做存储
