# Jarvis 粤语语音交互系统 PRD

## 1. 项目概述

### 1.1 项目名称
Jarvis 粤语语音交互系统

### 1.2 项目背景
随着人工智能技术的发展，语音交互已成为人机交互的重要方式。然而，市面上大多数语音助手对粤语的支持不够完善，特别是在老年群体中，粤语是他们最熟悉和习惯的语言。本项目旨在构建一个专门支持粤语的语音交互系统，为粤语用户提供更自然、更便捷的语音交互体验。

### 1.3 项目目标
构建一个完整的粤语语音交互系统，能够：
- 准确识别粤语语音输入
- 理解用户意图并生成合适的粤语回复
- 以自然流畅的粤语语音形式回应用户
- 为老年用户群体提供简单易用的交互界面

## 2. 核心问题定义

### 2.1 当前痛点
1. **语音识别准确性问题**：现有系统对粤语识别不够准确
2. **语音合成质量问题**：生成的语音中夹杂了提示词内容（如"用粤语"）
3. **用户界面体验问题**：Gradio界面不够美观，用户体验差
4. **性能延迟问题**：在MacBook Air M3上运行CosyVoice2流式合成存在较大延迟
5. **语言一致性问题**：LLM生成的回复不是粤语，导致最终语音不够纯正
6. **交互流程问题**：用户需要简单的一键录音和自动处理流程

### 2.2 解决方案概述
通过优化语音识别、语音合成、用户界面和系统性能，构建一个高效、准确、易用的粤语语音交互系统。

## 3. 用户分析

### 3.1 目标用户群体
**主要用户群体：老年人群体**
- 年龄：55岁以上
- 语言背景：粤语为母语或主要交流语言
- 技术水平：对复杂技术操作不熟悉，需要简单直观的交互方式
- 使用场景：日常生活咨询、信息查询、陪伴聊天等

### 3.2 用户需求
1. **语言需求**：完全粤语交互，包括输入识别和输出语音
2. **易用性需求**：简单的操作流程，一键录音即可
3. **准确性需求**：准确理解粤语输入，给出合适的回复
4. **响应速度需求**：快速响应，减少等待时间
5. **语音质量需求**：清晰、自然的粤语语音输出

## 4. 功能需求

### 4.1 核心功能

#### 4.1.1 语音识别功能
**功能描述**：准确识别用户的粤语语音输入并转换为文本
**技术实现**：基于iic/SenseVoiceSmall模型
**验收标准**：
- 粤语识别准确率 ≥ 85%
- 支持30秒以内的连续语音识别
- 能够处理不同口音和语速的粤语

#### 4.1.2 智能对话功能
**功能描述**：理解用户输入的粤语文本，生成合适的粤语回复
**技术实现**：基于DeepSeek-Coder-V2-Lite-Instruct模型
**验收标准**：
- LLM生成的回复必须是粤语
- 回复内容相关性和准确性 ≥ 80%
- 支持多轮对话上下文理解

#### 4.1.3 语音合成功能
**功能描述**：将粤语文本转换为自然流畅的粤语语音
**技术实现**：基于CosyVoice2模型
**验收标准**：
- 生成的语音为纯正粤语，无提示词混入
- 语音流畅度和自然度评分 ≥ 4.0/5.0
- 支持流式语音合成，减少延迟

#### 4.1.4 用户交互界面
**功能描述**：提供简洁美观的语音交互界面
**技术实现**：基于Gradio框架
**验收标准**：
- 界面简洁美观，适合老年用户使用
- 一键录音开始/停止功能
- 清晰的状态反馈和进度提示

### 4.2 性能要求

#### 4.2.1 响应时间要求
- 语音识别响应时间：< 3秒
- LLM生成回复时间：< 5秒
- 语音合成延迟：< 2秒
- 端到端总响应时间：< 10秒

#### 4.2.2 硬件适配要求
- 支持MacBook Air M3 (24GB内存, 10核GPU)
- 优化内存使用，避免内存溢出
- 充分利用GPU加速能力

#### 4.2.3 稳定性要求
- 系统连续运行稳定性 ≥ 99%
- 异常情况下的错误处理和恢复
- 音频质量保证，避免噪音和失真

## 5. 技术架构

### 5.1 系统架构
```
用户界面 (Gradio) 
    ↓
语音录制 (listen/)
    ↓
语音识别 (influence/SenseVoiceSmall)
    ↓
智能对话 (influence/DeepSeek-Coder-V2-Lite)
    ↓
语音合成 (cosyvoice/CosyVoice2)
    ↓
语音播放
```

### 5.2 核心模块

#### 5.2.1 语音处理模块 (listen/)
- 负责音频录制和预处理
- 音频格式转换和质量优化
- 噪音抑制和增强

#### 5.2.2 语音识别模块 (influence/)
- 基于SenseVoiceSmall的粤语识别
- 音频到文本的转换
- 识别结果的后处理

#### 5.2.3 对话生成模块 (influence/)
- 基于DeepSeek-Coder-V2-Lite的智能对话
- 粤语提示词工程
- 上下文管理和对话历史

#### 5.2.4 语音合成模块 (cosyvoice/)
- 基于CosyVoice2的粤语语音合成
- 流式语音生成优化
- 语音质量控制

### 5.3 开发约束和技术要求

#### 5.3.1 代码修改原则
**重要原则**：修改现有代码时请确保不影响功能
- 对现有模块进行修改时，必须保持原有API接口的兼容性
- 所有功能性修改必须通过完整的回归测试
- 代码修改应采用渐进式优化，避免大幅重构
- 保留原有功能的同时，新增优化功能
- 修改前必须备份关键代码，确保可回滚

**具体要求**：
- 修改 `cosyvoice/cli/cosyvoice.py` 时，保持 `inference_instruct2` 方法的输入输出格式不变
- 优化 `jarvis.py` 中的 `brain_streaming` 函数时，确保流式处理逻辑正常工作
- 修改 `influence/influence.py` 时，保持 `voice_to_text` 和 `llm` 方法的功能完整性
- 界面优化时，保持Gradio组件的基本功能不受影响

#### 5.3.2 macOS性能优化要求
**充分利用Mac OS性能和cosyvoice2的流式语音处理**
- 针对MacBook Air M3 (24GB内存, 10核GPU)进行专门优化
- 充分利用Apple Silicon的统一内存架构
- 优化Metal Performance Shaders (MPS)的使用
- 实现高效的多核CPU并行处理

**具体优化策略**：
- 利用macOS的Grand Central Dispatch (GCD)进行并发处理
- 优化CosyVoice2模型在Apple Silicon上的推理性能
- 实现智能的内存管理，避免内存碎片
- 充分利用GPU加速能力进行模型推理
- 优化流式音频处理的缓冲策略

#### 5.3.3 流式语音处理优化
**CosyVoice2流式处理优化**：
- 实现低延迟的流式语音合成
- 优化音频块的大小和缓冲策略
- 减少首次合成的冷启动时间
- 实现预测性的资源预加载

**性能目标**：
- 首次语音合成延迟 < 1秒
- 流式合成延迟 < 200ms
- 内存使用效率 > 80%
- GPU利用率 > 70%

## 6. 详细需求

### 6.1 问题1：语音合成中提示词混入问题
**问题描述**：生成的语音开头夹杂了提示词"用粤语"的语音
**解决方案**：
- 优化CosyVoice2的指令处理逻辑
- 调整提示词的传递方式，确保不被合成到语音中
- 实现提示词与合成文本的分离机制

**技术实现**：
- 修改`cosyvoice/cli/cosyvoice.py`中的inference_instruct2方法
- 优化指令文本的处理流程
- 添加语音输出的过滤机制

### 6.2 问题2：界面优化需求
**问题描述**：Gradio界面不够简洁美观
**解决方案**：
- 重新设计界面布局，采用更适合老年用户的设计风格
- 简化操作流程，实现一键录音功能
- 添加清晰的状态提示和反馈

**设计要求**：
- 大按钮设计，易于点击
- 清晰的状态指示器
- 简洁的色彩搭配
- 响应式布局适配

### 6.3 问题3：性能优化需求
**问题描述**：CosyVoice2在MacBook Air M3上存在较大延迟
**解决方案**：
- 优化模型加载和推理流程
- 实现更高效的流式处理
- 优化内存使用和GPU利用率

**优化策略**：
- 模型量化和压缩
- 并行处理优化
- 缓存机制实现
- 预热机制减少首次延迟

### 6.4 问题4：语言一致性需求
**问题描述**：LLM生成的答案不是粤语
**解决方案**：
- 优化LLM的粤语提示词
- 实现粤语回复的质量检查
- 添加粤语语言模型的fine-tuning

**实现方案**：
- 设计专门的粤语提示词模板
- 实现粤语文本的验证机制
- 集成粤语语言检测功能

### 6.5 问题5：交互流程优化需求
**问题描述**：用户需要简单的一键录音和自动处理流程
**解决方案**：
- 实现一键录音开始/停止功能
- 自动化后续的识别、生成、合成流程
- 提供清晰的进度反馈

**功能特性**：
- 点击开始录音，再次点击停止录音
- 自动进行语音识别和回复生成
- 实时显示处理状态和进度
- 支持录音过程中的实时反馈

## 7. 验收标准

### 7.1 功能验收标准
- [ ] 粤语语音识别准确率 ≥ 85%
- [ ] LLM生成粤语回复的正确率 ≥ 80%
- [ ] 语音合成无提示词混入
- [ ] 界面操作简洁，一键录音功能正常
- [ ] 端到端响应时间 < 10秒

### 7.2 性能验收标准
- [ ] 系统在MacBook Air M3上稳定运行
- [ ] 内存使用不超过20GB
- [ ] CPU使用率 < 80%
- [ ] 连续运行24小时无异常

### 7.3 用户体验验收标准
- [ ] 老年用户能够独立完成录音和对话
- [ ] 界面响应及时，无明显卡顿
- [ ] 语音质量清晰，无噪音干扰
- [ ] 用户满意度 ≥ 4.0/5.0

## 8. 风险评估

### 8.1 技术风险
- **模型性能风险**：粤语识别和合成模型可能在特定场景下表现不佳
- **硬件兼容性风险**：在不同硬件配置下的性能差异
- **依赖库风险**：第三方依赖库的版本兼容性问题

### 8.2 用户体验风险
- **学习成本风险**：老年用户可能需要时间适应新系统
- **期望管理风险**：用户对AI能力的过高期望
- **语言差异风险**：不同地区粤语方言的差异

### 8.3 缓解措施
- 充分的测试和验证
- 用户友好的错误处理机制
- 详细的用户使用指导
- 持续的性能监控和优化

## 9. 开发计划

### 9.1 第一阶段（1-2周）
- 修复语音合成中的提示词混入问题
- 实现基础的界面优化
- 初步的性能优化

### 9.2 第二阶段（2-3周）
- 完成LLM粤语回复优化
- 实现一键录音功能
- 深度性能优化

### 9.3 第三阶段（1周）
- 系统集成测试
- 用户体验测试
- 文档完善和部署准备

## 10. 成功指标

### 10.1 量化指标
- 语音识别准确率：≥ 85%
- 响应时间：< 10秒
- 用户满意度：≥ 4.0/5.0
- 系统稳定性：≥ 99%

### 10.2 定性指标
- 用户能够流畅地进行粤语对话
- 界面操作简单直观
- 语音质量自然清晰
- 系统响应及时可靠

---

*本PRD文档版本：v1.0*
*创建日期：2025年7月16日*
*负责人：项目开发团队*
