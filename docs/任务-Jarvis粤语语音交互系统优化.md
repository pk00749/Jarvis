# 任务-Jarvis粤语语音交互系统优化

## 任务描述
基于现有的Jarvis粤语语音交互系统，解决当前存在的关键问题，优化系统性能和用户体验。主要目标是修复语音合成中的提示词混入问题、优化界面设计、提升系统性能、确保LLM生成纯粤语回复，并实现简化的一键录音交互流程。

## 验收标准
- [ ] 语音合成无提示词"用粤语"混入
- [ ] 界面简洁美观，适合老年用户使用
- [ ] 系统在MacBook Air M3上性能优化，端到端响应时间<10秒
- [ ] LLM生成纯粤语回复，语音输出为纯正粤语
- [ ] 实现一键录音开始/停止功能
- [ ] 所有功能修改不影响现有基础功能
- [ ] 系统稳定性≥99%，连续运行24小时无异常

## 任务分解

### 阶段1：代码分析和问题定位
- [ ] 分析jarvis.py中的brain_streaming函数流程
- [ ] 检查cosyvoice/cli/cosyvoice.py中的inference_instruct2方法
- [ ] 分析提示词"用粤语"混入语音的原因
- [ ] 评估当前系统在MacBook Air M3上的性能瓶颈
- [ ] 检查influence/influence.py中的LLM调用逻辑

**预期完成时间**: 1天
**负责模块**: 所有核心模块

### 阶段2：语音合成提示词混入问题修复
- [ ] 修改cosyvoice/cli/cosyvoice.py中的指令处理逻辑
- [ ] 实现提示词与合成文本的分离机制
- [ ] 优化inference_instruct2方法，确保指令不被合成到语音中
- [ ] 添加语音输出过滤机制
- [ ] 测试修复后的语音合成功能

**预期完成时间**: 2-3天
**负责模块**: cosyvoice/
**技术要求**: 保持inference_instruct2方法的输入输出格式不变

### 阶段3：LLM粤语回复优化
- [ ] 设计专门的粤语提示词模板
- [ ] 修改influence/influence.py中的LLM调用逻辑
- [ ] 实现粤语文本验证机制
- [ ] 集成粤语语言检测功能
- [ ] 测试LLM生成粤语回复的准确性

**预期完成时间**: 2-3天
**负责模块**: influence/
**技术要求**: 保持voice_to_text和llm方法的功能完整性

### 阶段4：macOS性能优化
- [ ] 实现Apple Silicon M3芯片的专门优化
- [ ] 优化CosyVoice2模型在Apple Silicon上的推理性能
- [ ] 实现Metal Performance Shaders (MPS)优化
- [ ] 利用Grand Central Dispatch进行并发处理
- [ ] 优化内存管理，避免内存碎片
- [ ] 实现智能缓存机制
- [ ] 优化流式音频处理的缓冲策略

**预期完成时间**: 3-4天
**负责模块**: cosyvoice/, jarvis.py
**性能目标**: 首次语音合成延迟<1秒，流式合成延迟<200ms

### 阶段5：流式语音处理优化
- [ ] 优化CosyVoice2的流式处理逻辑
- [ ] 实现低延迟的流式语音合成
- [ ] 优化音频块大小和缓冲策略
- [ ] 减少首次合成的冷启动时间
- [ ] 实现预测性资源预加载
- [ ] 优化jarvis.py中的brain_streaming函数

**预期完成时间**: 2-3天
**负责模块**: cosyvoice/, jarvis.py
**技术要求**: 确保流式处理逻辑正常工作

### 阶段6：用户界面优化
- [ ] 重新设计Gradio界面布局
- [ ] 实现适合老年用户的大按钮设计
- [ ] 添加清晰的状态指示器
- [ ] 实现简洁的色彩搭配
- [ ] 优化响应式布局适配
- [ ] 实现一键录音开始/停止功能
- [ ] 添加实时状态反馈和进度提示

**预期完成时间**: 2-3天
**负责模块**: jarvis.py (界面部分)
**技术要求**: 保持Gradio组件的基本功能不受影响

### 阶段7：系统集成测试
- [ ] 端到端功能测试
- [ ] 性能压力测试
- [ ] 语音识别准确率测试
- [ ] 语音合成质量测试
- [ ] 用户界面易用性测试
- [ ] 系统稳定性测试（24小时运行）
- [ ] 回归测试确保原有功能不受影响

**预期完成时间**: 2天
**负责模块**: 整个系统

### 阶段8：文档更新和部署准备
- [ ] 更新README.md文档
- [ ] 更新技术文档
- [ ] 创建用户使用指南
- [ ] 性能优化报告
- [ ] 部署配置优化

**预期完成时间**: 1天
**负责模块**: 文档和配置

## 技术约束
- **代码修改原则**: 修改现有代码时必须确保不影响功能
- **性能要求**: 充分利用macOS和CosyVoice2的流式语音处理能力
- **硬件环境**: MacBook Air M3 (24GB内存, 10核GPU)
- **兼容性**: 保持现有API接口的兼容性

## 风险控制
- [ ] 每个阶段完成后进行功能验证
- [ ] 重要代码修改前进行备份
- [ ] 渐进式优化，避免大幅重构
- [ ] 持续监控系统性能指标

## 当前状态
**任务创建时间**: 2025年7月17日
**当前阶段**: 准备开始阶段1
**整体进度**: 0%

## 问题和注意事项
- 需要特别关注CosyVoice2在Apple Silicon上的性能表现
- 粤语语言处理需要考虑不同地区方言差异
- 老年用户界面设计需要特别考虑可访问性
- 系统优化时需要平衡性能和准确性

---
**最后更新时间**: 2025年7月17日
**更新内容**: 初始任务创建
