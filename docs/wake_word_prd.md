# 产品需求文档：Jarvis 唤醒词功能 - V1.0

## 1. 修订历史
| 版本号 | 修订日期   | 修订人 | 修订内容 |
| ------ | ---------- | ------ | -------- |
| V1.0   | 2025-08-04 | AI助手 | 初稿创建 |
| V1.1   | 2025-08-04 | AI助手 | 明确界面布局、状态提示和关键词权重机制 |

## 2. 项目背景与目标
### 2.1 核心问题
目前 Jarvis 语音助手需要用户手动点击录音按钮来启动语音交互，缺乏自然的语音唤醒机制。用户期望能够通过说出特定的唤醒词（粤语"喂"）来自动启动对话，提升交互的便利性和自然度。

### 2.2 需求目标
1. **提升用户体验**：实现免按键的语音唤醒交互方式
2. **保持技术一致性**：基于现有的 SenseVoice 识别引擎实现唤醒词检测
3. **支持粤语识别**：专门针对粤语"喂"进行优化识别
4. **提供管理界面**：增加独立的唤醒词设置分页，便于功能测试和调试

## 3. 用户画像与场景
### 3.1 目标用户
- Jarvis 语音助手的现有用户
- 偏好粤语交互的用户群体
- 希望获得更自然语音交互体验的用户

### 3.2 用户场景
- **场景一**：用户在使用设备时，无需手动操作，直接说"喂"启动语音助手
- **场景二**：开发者/测试人员需要调试唤醒词功能的敏感度和状态
- **场景三**：用户需要在某些情况下临时关闭唤醒词功能

## 4. 功能需求详述

### 4.1 功能模块一：唤醒词检测引擎
#### 4.1.1 用户故事 1.1：持续语音监听
- **作为** Jarvis 用户
- **我希望** 点击"开始监听"按钮后，系统能持续监听麦克风输入
- **以便于** 随时通过语音唤醒助手，无需重复点击按钮

**业务规则与逻辑**:
1. 用户点击"开始监听"按钮后，系统启动后台持续监听
2. 使用现有的 SenseVoice 引擎处理实时语音输入
3. 监听过程中，识别结果实时显示在页面上
4. 系统在 TTS 播放期间暂停唤醒词检测，播放完成后恢复监听

**验收标准**:
1. 点击开始监听后，页面显示"正在监听..."状态
2. 麦克风输入的语音内容能实时转换为文字并显示
3. TTS 播放时唤醒词检测暂停，播放结束后自动恢复

#### 4.1.2 用户故事 1.2：粤语"喂"唤醒识别
- **作为** Jarvis 用户
- **我希望** 说出粤语"喂"时能被准确识别并触发唤醒
- **以便于** 自然地启动与 Jarvis 的对话

**业务规则与逻辑**:
1. 当 SenseVoice 识别结果包含"喂"字时，系统进行关键词权重计算
2. **关键词权重机制**：
   - 单个"喂" = 权重分数 1.0
   - 连续"喂喂" = 权重分数 1.5
   - 连续"喂喂喂"或更多 = 权重分数 2.0
3. 当权重分数达到设定的触发阈值时，判定为唤醒成功
4. 唤醒成功后，页面显示"识别成功"状态
5. 唤醒成功后立即切换到对话模式，等待用户后续指令

**验收标准**:
1. 不同数量的"喂"字能产生对应的权重分数
2. 权重分数达到阈值时能成功触发唤醒
3. 唤醒成功时页面明确显示"识别成功"提示
4. 非"喂"字内容不会误触发唤醒

#### 4.1.3 用户故事 1.3：智能对话流程衔接
- **作为** Jarvis 用户
- **我希望** 唤醒成功后能顺畅地进入正常对话流程
- **以便于** 获得完整的语音助手服务体验

**业务规则与逻辑**:
1. 唤醒成功后，系统转入对话模式，继续监听用户指令
2. 用户后续语音输入通过现有的 LLM 处理生成回答
3. LLM 回答通过 CosyVoice 转换为语音播放
4. 对话完成后，系统返回唤醒词检测模式

**验收标准**:
1. 唤醒后能正常接收和处理用户的语音指令
2. LLM 能生成恰当的回答内容
3. CosyVoice 能正常播放语音回复
4. 对话结束后自动返回唤醒词监听状态

### 4.2 功能模块二：唤醒词设置界面（新标签页）
#### 4.2.1 用户故事 2.1：功能开关控制
- **作为** 用户/开发者
- **我希望** 能够开启或关闭唤醒词功能
- **以便于** 根据需要控制功能的启用状态

**业务规则与逻辑**:
1. 在 Gradio 界面中新增"唤醒词设置"标签页
2. 提供唤醒词功能的开关按钮
3. 关闭时停止所有唤醒词检测活动
4. 开启时恢复正常的唤醒词检测流程
5. 状态变更立即生效

**界面布局**:
- 作为 Gradio 界面的新标签页（与主界面并列）
- 标签页名称："唤醒词设置"
- 页面布局简洁，包含功能开关、敏感度控制和状态显示区域

**验收标准**:
1. 新标签页在界面中正常显示
2. 开关状态在界面上清晰可见
3. 关闭功能时确实停止唤醒词检测
4. 开启功能时能正常启动唤醒词检测

#### 4.2.2 用户故事 2.2：敏感度调节
- **作为** 开发者/测试人员
- **我希望** 能够调整唤醒词的识别敏感度
- **以便于** 优化识别准确率和降低误触发率

**业务规则与逻辑**:
1. 提供敏感度调节滑块，范围为 0.8 - 2.0
2. 敏感度实际控制关键词权重的触发阈值：
   - 低敏感度（2.0）：需要连续多个"喂"才能触发
   - 中敏感度（1.2）：单个"喂"即可触发，但有一定容错
   - 高敏感度（0.8）：单个"喂"更容易触发
3. 敏感度变更实时生效
4. 默认设置为中等敏感度（1.2）

**验收标准**:
1. 敏感度调节滑块操作正常
2. 不同敏感度设置下识别效果有明显差异
3. 设置能够保存并��页面刷新后保持

#### 4.2.3 用户故事 2.3：状态监控与显示
- **作为** 用户/开发者
- **我希望** 能够实时查看唤醒词检测的当前状态
- **以便于** 了解系统运行情况和进行故障排查

**业务规则与逻辑**:
1. 显示当前监听状态（监听中/暂停/关闭）
2. 实时显示语音识别结果（文字形式）
3. 显示唤醒词匹配状态和权��分数
4. 提供识别历史记录（最近5条）

**状态提示规范**:
- 仅使用文字提示，不使用声音或复杂视觉效果
- 状态显示区域使用清晰的文字描述
- 关键状态变化时文字颜色或样式有所区别

**验收标准**:
1. 状态显示准确反映系统当前状态
2. 语音识别结果实时更新
3. 唤醒成功时状态显示明确变化
4. 历史记录正确记录识别内容和权重分数
5. 代码注释清晰，便于后续维护
6. 代码精简，不重复代码，利用面向对象的特性，如继承和多态。

## 5. 边界条件与约束
1. **语言限制**：当前版本仅支持粤语"喂"作为唤醒词，不支持其他语言或词汇
2. **硬件要求**：需要正常工作的麦克风设备
3. **网络依赖**：SenseVoice 本地运行，但 LLM 和 TTS 的 API 模式需要网络连接
4. **性能约束**：持续监听可能增加 CPU 使用率，需要在体验和性能间平衡
5. **检测失败处理**：识别失败时继续监听，不中断检测流程
6. **界面约束**：唤醒词设置作为独立标签页，不修改现有主界面布局

## 6. 非功能性需求
- **响应性能**：唤醒词识别响应时间应小于 2 秒
- **稳定性要求**：持续监听过程中系统应保持稳定，不出现崩溃
- **易用性要求**：界面简洁明了，无需用户手册即可使用
- **兼容性要求**：与现有的 Gradio 界面框架保持兼容

## 7. 数据指标
1. **唤醒成功率**：粤语"喂"的正确识别率应达到 90% 以上
2. **误触发率**：非唤醒词内容的误触发率应控制在 5% 以下
3. **响应时间**：从说出唤醒词到系统响应的平均时间应小于 2 秒

## 8. 待讨论/待明确事项
1. **关键词权重调优**：具体��权重分数和阈值需要通过实际测试确定最佳参数
2. **多用户场景**：如何处理多个用户同时使用或环境中有其他人声的情况
3. **唤醒词扩展**：未来是否考虑支持自定义唤醒词或其他语言
4. **电源管理**：长时间监听对设备电池消耗的影响及优化策略

## 9. 技术实现提示
### 9.1 核心技术栈
- **语音识别**：基于现有 SenseVoice 引擎
- **界面框架**：Gradio（新增标签页）
- **音频处理**：PyAudio（持续音频流处理）
- **状态管理**：Python 多线程处理

### 9.2 关键技术点
1. **实时音频流处理**：需要改造现有的录音逻辑，从固定时长录音改为持续流式处理
2. **关键词权重算法**：基于 SenseVoice 识别结果进行关键词匹配和权重计算
3. **状态机管理**：监听状态、唤醒状态、对话状态的切换控制
4. **线程协调**：音频处理、语音识别、状态更新的多线程协调
5. **Gradio 标签页扩展**：在现有界面基础上新增标签页组件
